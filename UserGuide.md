# Spark ROOT User Guide

**Current Release available on Maven Central is 0.1.7**

## Requirements
- Apache Spark 2.0 and above
- Scala 2.11
- hdfs 

Comment: hdfs is required for now even for local testing. The ROOT file can reside on local system, hdfs will fall back on local file system if you specify the proper redirector(URI) file:/path/to/file. This requirement will be lifted in later versions

## Data
Data that is used in this guide can either be copied locally (from specified location) or
is available on hdfs at CERN. 

- /afs/cern.ch/work/v/vkhriste/public/spark-root-testdata
- hdfs:/cms/bigdatasci/vkhriste/data

All of the test files used/shown are available from the above locations

## Instructions
- It is assumed that the user confirms to the requirements.
- std out spark logging might differ based on 2.0 or 2.1 spark versions 

## Example Higgs -> 2 muons Analysis

First example comes from Higgs to Dimuon Analysis. Since this was the very first test of the ability to process stl containers, we include this example here. ROOT files come from the CMS Higgs Analysis. 

This example contains:
- STL Containers of Composite Classes
- Composites with other nested Composites  

```
you start by running spark shell, spark-root is hosted on maven central
./spark-shell --packages org.diana-hep:spark-root_2.11:0.1.7

you have to import the implicit ROOT DataFrameReader
import org.dianahep.sparkroot._

as simple as reading in parquet or avro
scala> val df = spark.sqlContext.read.root("file:/Users/vk/software/Analysis/files/test/ntuple_drellyan_test.root")

if you want to get the schema
scala> df.printSchema

simply read in the first few entries
scala> df.show
+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+-------------------+-------------------+--------------------+-------------------+-------------------+
|               Muons|                Jets|            Vertices|               Event|      EventAuxiliary|                 MET|           Electrons|                Taus|             GenJets|          GenHpreFSR|      Track1HpreFSR|      Track2HpreFSR|         GenHpostFSR|     Track1HpostFSR|     Track2HpostFSR|
+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+-------------------+-------------------+--------------------+-------------------+-------------------+
|[[[[],-1,58.45683...|[[[],-56.130245,3...|[[[],1,0.10404386...|[1,2284,1141514,-...|[14,1,WrappedArra...|[-24.082912,-20.6...|                  []|[[[[],-1,58.45683...|[[[],-48.697712,5...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,79.4607,...|[[[],82.01612,40....|[[[],1,0.10480793...|[1,2284,1141530,-...|[21,1,WrappedArra...|[5.1337976,-2.230...|                  []|[[[[],-1,79.4607,...|[[[],76.376305,85...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,46.150543...|[[[],14.730642,51...|[[[],1,0.10269206...|[1,2284,1141537,-...|[17,1,WrappedArra...|[10.524356,-18.87...|                  []|[[[[],1,51.58235,...|[[[],14.095102,51...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,75.89284,...|[[[],114.56533,35...|[[[],1,0.10461336...|[1,2284,1141539,-...|[21,-1,WrappedArr...|[-20.272661,-47.9...|                  []|[[[[],1,75.89284,...|[[[],130.89626,13...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,60.506573...|[[[],-51.59212,-4...|[[[],1,0.10417961...|[1,2284,1141549,-...|[7,-1,WrappedArra...|[23.657387,12.934...|                  []|[[[[],1,60.506573...|[[[],60.703228,64...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,68.28817,...|[[[],59.218204,50...|[[[],1,0.1074408,...|[1,2284,1141562,-...|[23,-1,WrappedArr...|[16.848894,-27.77...|                  []|[[[[],1,68.28817,...|[[[],55.269707,73...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,37.80587...|[[[],39.670628,-4...|[[[],1,0.10354543...|[1,2284,1141570,-...|[28,1,WrappedArra...|[-24.10786,2.3670...|                  []|[[[[],-1,39.23528...|[[[],38.852043,59...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,23.450613...|[[[],26.758205,-1...|[[[],1,0.1030016,...|[1,2284,1141573,-...|[27,1,WrappedArra...|[16.003109,11.614...|                  []|[[[[],1,23.450613...|[[[],20.456713,23...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,104.45745...|[[[],74.86457,-92...|[[[],1,0.10561662...|[1,2284,1141584,-...|[13,1,WrappedArra...|[-35.928448,-8.86...|                  []|[[[[],1,105.83742...|[[[],67.1848,107....|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,44.337986...|[[[],34.875015,-3...|[[[],1,0.10517144...|[1,2284,1141607,-...|[12,1,WrappedArra...|[18.736425,12.216...|                  []|[[[[],1,44.337986...|[[[],-35.055054,4...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,102.55752...|[[[],47.974884,-1...|[[[],1,0.10584812...|[1,2284,1141615,-...|[25,1,WrappedArra...|[-13.362669,-5.56...|[[[[],1,13.919632...|[[[[],1,102.55752...|[[[],39.016106,10...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,52.61641...|[[[],-62.607162,4...|[[[],1,0.10308474...|[1,2284,1141625,-...|[20,1,WrappedArra...|[-4.592789,-6.262...|                  []|[[[[],-1,52.61641...|[[[],-50.65656,50...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,49.11682...|[[[],6.3082056,-5...|[[[],1,0.10427020...|[1,2284,1141630,-...|[31,1,WrappedArra...|[-16.047827,-9.67...|                  []|[[[[],-1,49.11682...|[[[],5.80125,49.4...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,51.36520...|[[[],-60.40986,10...|[[[],1,0.10393878...|[1,2284,1141632,-...|[28,1,WrappedArra...|[3.571496,-42.620...|                  []|[[[[],-1,52.83650...|[[[],-51.823174,5...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,51.510174...|[[[],-56.862194,1...|[[[],1,0.10398592...|[1,2284,1141636,-...|[15,1,WrappedArra...|[-1.4284059,-1.17...|                  []|[[[[],1,51.510174...|[[[],-49.341698,5...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,754.1653...|[[[],39.138664,-3...|[[[],1,0.10950266...|[1,2284,1141653,-...|[30,1,WrappedArra...|[18.112919,37.023...|[[[[],1,14.508821...|[[[[],1,40.970993...|[[[],32.680946,42...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,139.81227...|[[[],144.01634,27...|[[[],1,0.10510063...|[1,2284,1141659,-...|[23,1,WrappedArra...|[-67.19844,-28.11...|[[[[],1,21.56401,...|[[[[],1,139.81227...|[[[],135.25948,13...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],-1,23.77856...|[[[],-44.015366,-...|[[[],1,0.10366636...|[1,2284,1141687,-...|[26,-1,WrappedArr...|[14.153416,53.148...|[[[[],1,50.283623...|[[[[],1,29.047192...|[[[],-42.410625,7...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,48.584915...|[[[],21.023222,51...|[[[],1,0.10413411...|[1,2284,1141699,-...|[17,-1,WrappedArr...|[-6.2544007,7.667...|                  []|[[[[],1,50.742844...|[[[],18.974922,48...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
|[[[[],1,41.75093,...|[[[],29.658821,33...|[[[],1,0.10500754...|[1,2284,1141705,-...|[20,1,WrappedArra...|[14.404951,-13.06...|                  []|[[[[],1,41.75093,...|[[[],-31.166578,4...|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|[0.0,0.0,0.0,0.0,...|[0,0.0,0.0,0.0,0.0]|[0,0.0,0.0,0.0,0.0]|
+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+-------------------+-------------------+--------------------+-------------------+-------------------+
only showing top 20 rows

most basic query - number of "Events" in this file
scala> df.count
res2: Long = 1317496

scala> df.select("Muons").show
+--------------------+
|               Muons|
+--------------------+
|[[[[],-1,58.45683...|
|[[[[],-1,79.4607,...|
|[[[[],1,46.150543...|
|[[[[],1,75.89284,...|
|[[[[],1,60.506573...|
|[[[[],1,68.28817,...|
|[[[[],-1,37.80587...|
|[[[[],1,23.450613...|
|[[[[],1,104.45745...|
|[[[[],1,44.337986...|
|[[[[],1,102.55752...|
|[[[[],-1,52.61641...|
|[[[[],-1,49.11682...|
|[[[[],-1,51.36520...|
|[[[[],1,51.510174...|
|[[[[],-1,754.1653...|
|[[[[],1,139.81227...|
|[[[[],-1,23.77856...|
|[[[[],1,48.584915...|
|[[[[],1,41.75093,...|
+--------------------+
only showing top 20 rows

scala> 
```
